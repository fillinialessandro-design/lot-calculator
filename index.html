<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Anti-cache per PWA / GitHub Pages -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <title>Lot Calculator PRO – Doppio account (MT4) v2.1</title>

  <style>
    :root{
      --bg:#050a14;
      --card:#0b1324;
      --card2:#0a1020;
      --text:#e7eefc;
      --muted:#a9b7d0;
      --line:rgba(255,255,255,.10);
      --blue:#2d6bff;
      --green:#19c37d;
      --red:#ff4d4f;
      --amber:#ffcc00;
      --shadow: 0 16px 40px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(900px 600px at 20% -10%, rgba(45,107,255,.25), transparent 60%),
                  radial-gradient(900px 600px at 110% 20%, rgba(25,195,125,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      line-height:1.25;
      padding:18px;
    }
    .wrap{max-width:760px;margin:0 auto}
    .title{
      text-align:center;
      padding:10px 0 18px;
    }
    h1{
      margin:0;
      font-size:32px;
      letter-spacing:.2px;
      line-height:1.15;
    }
    .sub{
      margin-top:8px;
      color:var(--muted);
      font-size:14px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin:12px 0;
      overflow:hidden;
    }
    .card h2{
      margin:0 0 12px 0;
      font-size:18px;
      color:var(--text);
    }
    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    @media (max-width:520px){
      .row{grid-template-columns:1fr}
      h1{font-size:28px}
    }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px;
    }
    select,input{
      width:100%;
      height:48px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(6,10,20,.55);
      color:var(--text);
      padding:0 14px;
      font-size:16px;
      outline:none;
    }
    input:focus, select:focus{
      border-color:rgba(45,107,255,.55);
      box-shadow:0 0 0 3px rgba(45,107,255,.18);
    }
    .hint{
      margin-top:10px;
      color:var(--muted);
      font-size:13px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      font-size:12px;
      color:var(--muted);
    }
    .onlineDot{
      width:9px;height:9px;border-radius:50%;
      background:var(--red);
      box-shadow:0 0 0 6px rgba(255,77,79,.12);
    }
    .onlineDot.ok{
      background:var(--green);
      box-shadow:0 0 0 6px rgba(25,195,125,.12);
    }
    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    button{
      border:0;
      border-radius:16px;
      padding:14px 18px;
      font-size:16px;
      font-weight:700;
      cursor:pointer;
    }
    .btnBlue{background:var(--blue); color:white; flex:1; min-width:160px;}
    .btnGrey{background:rgba(255,255,255,.08); color:var(--text); border:1px solid var(--line);}
    .btnRed{background:rgba(255,77,79,.16); color:#ffd7d7; border:1px solid rgba(255,77,79,.35);}
    .results{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width:520px){
      .results{grid-template-columns:1fr}
    }
    .resBox{
      border:1px solid rgba(25,195,125,.35);
      background:rgba(25,195,125,.10);
      border-radius:18px;
      padding:14px;
    }
    .resLabel{font-size:12px;color:#b9f7da;margin-bottom:8px}
    .resValue{
      font-size:30px;
      font-weight:900;
      letter-spacing:.2px;
      padding:10px 14px;
      background:rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      text-align:center;
    }
    .warn{
      margin-top:12px;
      border-radius:16px;
      padding:12px 12px;
      border:1px solid rgba(255,77,79,.35);
      background:rgba(255,77,79,.14);
      color:#ffe7e7;
      font-size:13px;
    }
    .ok{
      margin-top:10px;
      border-radius:16px;
      padding:10px 12px;
      border:1px solid rgba(25,195,125,.35);
      background:rgba(25,195,125,.10);
      color:#dfffea;
      font-size:13px;
    }
    .mini{
      font-size:12px;
      color:var(--muted);
      margin-top:10px;
    }
    .foot{
      text-align:center;
      color:rgba(255,255,255,.35);
      font-size:12px;
      margin-top:14px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="title">
      <h1>Lot Calculator PRO – Doppio account (MT4)</h1>
      <div class="sub">
        Strumenti di trading di precisione — Prodotto da Alessandro Fillini<br>
        <span style="opacity:.7">Precisione: XAUUSD (MT4 contract 100), USDJPY/GBPJPY (pip value reale in USD)</span>
      </div>
    </div>

    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
        <div class="pill">
          <span id="dot" class="onlineDot"></span>
          <span id="netTxt">Tassi: non verificati</span>
        </div>
        <div class="pill" title="Versione del file per evitare cache">
          v <span id="ver">2.1</span>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Commercio (condiviso)</h2>
      <div class="row">
        <div>
          <label>Simbolo</label>
          <select id="symbol">
            <option value="USDJPY">USDJPY</option>
            <option value="GBPJPY">GBPJPY</option>
            <option value="XAUUSD">XAUUSD</option>
          </select>
        </div>
        <div>
          <label>Rischio % (su Balance)</label>
          <input id="riskPct" type="number" inputmode="decimal" step="0.01" min="0" value="1">
        </div>
        <div>
          <label>Iscrizione (Entry)</label>
          <input id="entry" type="number" inputmode="decimal" step="0.00001" placeholder="es. 154.750">
        </div>
        <div>
          <label>Fermare (Stop)</label>
          <input id="stop" type="number" inputmode="decimal" step="0.00001" placeholder="es. 154.870">
        </div>
      </div>

      <div class="hint" id="distanceHint">Distanza ingresso-arresto: —</div>
      <div class="mini" id="quoteHint">Quote: —</div>
    </div>

    <div class="card">
      <h2>Conversioni (USD → EUR e USD → JPY)</h2>
      <div class="row">
        <div>
          <label>USD → JPY</label>
          <input id="usdJpy" type="number" inputmode="decimal" step="0.000001" placeholder="es. 154.75">
        </div>
        <div>
          <label>USD → EUR</label>
          <input id="usdEur" type="number" inputmode="decimal" step="0.000001" placeholder="es. 0.92">
        </div>
      </div>

      <div class="btnRow">
        <button class="btnGrey" id="btnRates">Aggiorna tassi (online)</button>
        <button class="btnRed" id="btnClearRates">Reset tassi</button>
      </div>
      <div class="mini" id="ratesInfo">Ultimo aggiornamento: —</div>
      <div class="mini" id="ratesActive">Tassi attivi: —</div>
    </div>

    <div class="card">
      <h2>Conti</h2>

      <div class="row">
        <div>
          <label>Conto A — Balance</label>
          <input id="balA" type="number" inputmode="decimal" step="0.01" value="100000">
        </div>
        <div>
          <label>Conto A — Valuta</label>
          <select id="curA">
            <option value="USD">Dollaro statunitense (USD)</option>
            <option value="EUR">Euro (EUR)</option>
          </select>
        </div>

        <div>
          <label>Conto B — Balance</label>
          <input id="balB" type="number" inputmode="decimal" step="0.01" value="6000">
        </div>
        <div>
          <label>Conto B — Valuta</label>
          <select id="curB">
            <option value="USD">Dollaro statunitense (USD)</option>
            <option value="EUR">Euro (EUR)</option>
          </select>
        </div>
      </div>

      <div class="btnRow">
        <button class="btnBlue" id="btnCalc">Calcolare</button>
        <button class="btnGrey" id="btnReset">Reset campi</button>
      </div>

      <div class="results">
        <div class="resBox">
          <div class="resLabel">Lotti Conto A</div>
          <div class="resValue" id="lotsA">—</div>
        </div>
        <div class="resBox">
          <div class="resLabel">Lotti Conto B</div>
          <div class="resValue" id="lotsB">—</div>
        </div>
      </div>

      <div id="msg"></div>
    </div>

    <div class="foot">© 2026 Alessandro Fillini — uso personale</div>
  </div>

<script>
/**
 * MT4 assumptions (standard, per broker tipico):
 * - USDJPY / GBPJPY: 1 lot = 100,000 base units
 *   pip size = 0.01
 *   pip value in QUOTE currency per lot = 100,000 * 0.01 = 1000 JPY/pip
 *   then convert JPY->USD: / USDJPY rate
 *
 * - XAUUSD: MT4 contract size typically 100 oz per 1 lot
 *   tick/pip size in price: use 0.01 as "pip" unit? No.
 *   We compute from PRICE distance in USD:
 *     loss_per_lot_usd = |entry-stop| * contractSize
 *   with contractSize = 100 (oz)
 */

const VERSION = "2.1";

/** UI */
const el = (id) => document.getElementById(id);

const state = {
  rates: {
    usdJpy: null,
    usdEur: null,
    updatedAt: null
  }
};

/** LocalStorage keys */
const LS_KEY = "lotcalc_mt4_v21_rates";

/** Helpers */
function n(x){
  const v = Number(x);
  return Number.isFinite(v) ? v : null;
}
function fmt(x, d=2){
  if (!Number.isFinite(x)) return "—";
  return x.toLocaleString("it-IT", {minimumFractionDigits:d, maximumFractionDigits:d});
}
function fmtSmart(x){
  if (!Number.isFinite(x)) return "—";
  const ax = Math.abs(x);
  const d = ax >= 100 ? 2 : ax >= 10 ? 2 : ax >= 1 ? 2 : 3;
  return x.toLocaleString("it-IT", {minimumFractionDigits:d, maximumFractionDigits:d});
}
function clampMinLot(lots, minLot=0.01){
  return Math.max(0, lots) < minLot ? minLot : lots;
}
function roundLot(lots){
  // MT4 spesso step 0.01 (puoi cambiare se vuoi)
  return Math.round(lots * 100) / 100;
}

function setOnline(ok){
  const dot = el("dot");
  const txt = el("netTxt");
  dot.classList.toggle("ok", !!ok);
  txt.textContent = ok ? "Tassi: online ok (o manuali validi)" : "Tassi: mancanti / non validi";
}

/** Rate storage */
function loadRates(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return;
    const obj = JSON.parse(raw);
    if(obj && typeof obj === "object"){
      state.rates.usdJpy = n(obj.usdJpy);
      state.rates.usdEur = n(obj.usdEur);
      state.rates.updatedAt = obj.updatedAt || null;
    }
  }catch(e){}
}
function saveRates(){
  try{
    localStorage.setItem(LS_KEY, JSON.stringify(state.rates));
  }catch(e){}
}
function resetRates(){
  state.rates.usdJpy = null;
  state.rates.usdEur = null;
  state.rates.updatedAt = null;
  saveRates();
  renderRates();
}

/** Fetch live rates (no API key) */
async function fetchRatesOnline(){
  // exchangerate.host può cambiare politiche; fallback su open.er-api.com
  // Qui proviamo 2 fonti.
  const sources = [
    async () => {
      const url = "https://api.exchangerate.host/latest?base=USD&symbols=JPY,EUR";
      const r = await fetch(url, {cache:"no-store"});
      if(!r.ok) throw new Error("exchangerate.host non ok");
      const j = await r.json();
      if(!j || !j.rates) throw new Error("risposta rates mancante");
      return {usdJpy: n(j.rates.JPY), usdEur: n(j.rates.EUR)};
    },
    async () => {
      const url = "https://open.er-api.com/v6/latest/USD";
      const r = await fetch(url, {cache:"no-store"});
      if(!r.ok) throw new Error("er-api non ok");
      const j = await r.json();
      if(!j || !j.rates) throw new Error("risposta rates mancante");
      return {usdJpy: n(j.rates.JPY), usdEur: n(j.rates.EUR)};
    }
  ];

  let lastErr = null;
  for(const s of sources){
    try{
      const out = await s();
      if(!out.usdJpy || !out.usdEur) throw new Error("tassi non numerici");
      state.rates.usdJpy = out.usdJpy;
      state.rates.usdEur = out.usdEur;
      state.rates.updatedAt = new Date().toISOString();
      saveRates();
      renderRates();
      return true;
    }catch(e){
      lastErr = e;
    }
  }
  renderRates();
  alert("Impossibile aggiornare online. Inserisci i tassi a mano (USD→JPY e USD→EUR).");
  console.warn(lastErr);
  return false;
}

/** Core: pip/price loss per 1 lot in USD */
function lossPerLotUSD(symbol, entry, stop, usdJpy){
  const dist = Math.abs(entry - stop);

  if(symbol === "XAUUSD"){
    const contractSize = 100; // MT4 standard for gold
    // price is already in USD per oz; P/L = dist * contractSize
    return dist * contractSize;
  }

  // JPY pairs:
  // pip size 0.01; pip value per lot in JPY = 1000 JPY per pip
  // pips = dist / 0.01
  const pipSize = 0.01;
  const pips = dist / pipSize;

  const pipValueJPY = 1000; // IMPORTANT: this is the key (100k * 0.01)
  // convert JPY to USD using USDJPY rate
  if(!usdJpy || usdJpy <= 0) return null;
  const pipValueUSD = pipValueJPY / usdJpy; // USD per pip per lot
  return pips * pipValueUSD;
}

function quoteCurrency(symbol){
  if(symbol === "XAUUSD") return "USD";
  if(symbol === "USDJPY") return "JPY";
  if(symbol === "GBPJPY") return "JPY";
  return "—";
}

/** Convert account currency risk amount to USD risk amount */
function riskAmountUSD(balance, riskPct, accountCurrency, usdEur){
  const risk = balance * (riskPct / 100);
  if(accountCurrency === "USD") return risk;
  // EUR account: convert EUR -> USD
  // we have USD->EUR, so EUR->USD = 1/(USD->EUR)
  if(!usdEur || usdEur <= 0) return null;
  return risk / usdEur;
}

/** Render rates box and online indicator */
function renderRates(){
  // read inputs first
  const uJ = n(el("usdJpy").value);
  const uE = n(el("usdEur").value);

  // if user typed, override state (and persist)
  if(uJ && uJ > 0) state.rates.usdJpy = uJ;
  if(uE && uE > 0) state.rates.usdEur = uE;

  // persist typed values too
  saveRates();

  const ok = !!(state.rates.usdJpy && state.rates.usdEur);
  setOnline(ok);

  el("usdJpy").value = state.rates.usdJpy ? String(state.rates.usdJpy) : "";
  el("usdEur").value = state.rates.usdEur ? String(state.rates.usdEur) : "";

  const upd = state.rates.updatedAt ? new Date(state.rates.updatedAt) : null;
  el("ratesInfo").textContent = "Ultimo aggiornamento: " + (upd ? upd.toLocaleString("it-IT") : "—");

  const activeTxt = `Tassi attivi: USD→JPY=${state.rates.usdJpy ? fmtSmart(state.rates.usdJpy) : "—"} • USD→EUR=${state.rates.usdEur ? fmtSmart(state.rates.usdEur) : "—"}`;
  el("ratesActive").textContent = activeTxt;

  el("ver").textContent = VERSION;
}

/** Distance hint */
function renderDistance(){
  const entry = n(el("entry").value);
  const stop  = n(el("stop").value);
  const sym = el("symbol").value;

  if(!entry || !stop){
    el("distanceHint").textContent = "Distanza ingresso-arresto: —";
    el("quoteHint").textContent = "Quote: —";
    return;
  }

  const dist = Math.abs(entry - stop);
  const quote = quoteCurrency(sym);

  let txt = "";
  if(sym === "XAUUSD"){
    txt = `Distanza ingresso-arresto: ${fmtSmart(dist)} (prezzo)`;
    el("quoteHint").textContent = `Quote: USD • Contract size MT4: 100 • Loss/lot = distanza×100`;
  }else{
    const pipSize = 0.01;
    const pips = dist / pipSize;
    txt = `Distanza ingresso-arresto: ${fmtSmart(dist)} (prezzo) ≈ ${fmtSmart(pips)} pips`;
    el("quoteHint").textContent = `Quote: ${quote} • Pip size: 0.01 • Pip value/lot: 1000 JPY → convertito in USD con USDJPY`;
  }

  el("distanceHint").textContent = txt;
}

/** Calculate lots for both accounts */
function calculate(){
  const sym = el("symbol").value;

  const riskPct = n(el("riskPct").value);
  const entry = n(el("entry").value);
  const stop = n(el("stop").value);

  const balA = n(el("balA").value);
  const curA = el("curA").value;
  const balB = n(el("balB").value);
  const curB = el("curB").value;

  const usdJpy = state.rates.usdJpy;
  const usdEur = state.rates.usdEur;

  const msg = el("msg");
  msg.innerHTML = "";

  // Basic validation
  const errs = [];
  if(!riskPct || riskPct <= 0) errs.push("Inserisci un rischio % valido.");
  if(!entry || !stop || entry <= 0 || stop <= 0) errs.push("Inserisci Entry e Stop validi (numeri).");
  if(!balA || balA <= 0) errs.push("Inserisci Balance Conto A valido.");
  if(!balB || balB <= 0) errs.push("Inserisci Balance Conto B valido.");

  // rates required for:
  // - JPY pairs always need USDJPY
  // - EUR accounts need USD→EUR
  if((sym !== "XAUUSD") && (!usdJpy || usdJpy <= 0)) errs.push("Per USDJPY/GBPJPY serve il tasso USD→JPY.");
  if((curA === "EUR" || curB === "EUR") && (!usdEur || usdEur <= 0)) errs.push("Per conti in EUR serve il tasso USD→EUR.");

  if(errs.length){
    msg.innerHTML = `<div class="warn">⚠️ ${errs.join("<br>")}</div>`;
    el("lotsA").textContent = "—";
    el("lotsB").textContent = "—";
    return;
  }

  // Risk amounts in USD
  const riskUsdA = riskAmountUSD(balA, riskPct, curA, usdEur);
  const riskUsdB = riskAmountUSD(balB, riskPct, curB, usdEur);

  if(!riskUsdA || !riskUsdB){
    msg.innerHTML = `<div class="warn">⚠️ Conversione valuta non possibile. Controlla i tassi.</div>`;
    return;
  }

  // Loss per 1 lot in USD
  const lossLotUsd = lossPerLotUSD(sym, entry, stop, usdJpy);

  if(!lossLotUsd || lossLotUsd <= 0){
    msg.innerHTML = `<div class="warn">⚠️ Impossibile calcolare la perdita/lot. Controlla i tassi e i valori.</div>`;
    return;
  }

  let lotsA = riskUsdA / lossLotUsd;
  let lotsB = riskUsdB / lossLotUsd;

  // MT4 minimum lot
  const minLot = 0.01;
  const rawA = lotsA;
  const rawB = lotsB;

  lotsA = roundLot(Math.max(0, lotsA));
  lotsB = roundLot(Math.max(0, lotsB));

  const belowA = lotsA > 0 && lotsA < minLot;
  const belowB = lotsB > 0 && lotsB < minLot;

  // display (rounded)
  el("lotsA").textContent = (lotsA === 0 ? "0.00" : lotsA.toFixed(2));
  el("lotsB").textContent = (lotsB === 0 ? "0.00" : lotsB.toFixed(2));

  // warnings if below minimum
  let warnTxt = "";
  if(rawA > 0 && rawA < minLot){
    const estRiskA = lossLotUsd * minLot; // USD
    warnTxt += `Conto A: calcolato ${rawA.toFixed(3)} < minimo broker (0.01). Se usi 0.01, rischio stimato ≈ ${fmt(estRiskA,2)} USD.<br>`;
    el("lotsA").textContent = "0.01";
  }
  if(rawB > 0 && rawB < minLot){
    const estRiskB = lossLotUsd * minLot;
    warnTxt += `Conto B: calcolato ${rawB.toFixed(3)} < minimo broker (0.01). Se usi 0.01, rischio stimato ≈ ${fmt(estRiskB,2)} USD.<br>`;
    el("lotsB").textContent = "0.01";
  }

  const summary = `
    <div class="ok">
      ✅ Calcolo OK.<br>
      • Perdita per 1.00 lot ≈ <b>${fmt(lossLotUsd,2)} USD</b><br>
      • Rischio A ≈ <b>${fmt(riskUsdA,2)} USD</b> • Rischio B ≈ <b>${fmt(riskUsdB,2)} USD</b>
    </div>
  `;

  if(warnTxt){
    msg.innerHTML = summary + `<div class="warn">⚠️ ${warnTxt}</div>`;
  }else{
    msg.innerHTML = summary;
  }
}

/** Reset fields */
function resetFields(){
  el("riskPct").value = "1";
  el("entry").value = "";
  el("stop").value = "";
  el("lotsA").textContent = "—";
  el("lotsB").textContent = "—";
  el("msg").innerHTML = "";
  renderDistance();
}

/** Init */
function init(){
  loadRates();
  el("ver").textContent = VERSION;

  // apply loaded values to inputs
  if(state.rates.usdJpy) el("usdJpy").value = state.rates.usdJpy;
  if(state.rates.usdEur) el("usdEur").value = state.rates.usdEur;

  renderRates();
  renderDistance();

  el("btnRates").addEventListener("click", fetchRatesOnline);
  el("btnClearRates").addEventListener("click", () => {
    resetRates();
  });

  ["usdJpy","usdEur"].forEach(id=>{
    el(id).addEventListener("input", () => {
      // update state + indicator as user types
      renderRates();
    });
  });

  ["symbol","entry","stop"].forEach(id=>{
    el(id).addEventListener("input", renderDistance);
    el(id).addEventListener("change", renderDistance);
  });

  el("btnCalc").addEventListener("click", calculate);
  el("btnReset").addEventListener("click", resetFields);

  // small: if online fetch fails due to CORS/offline, we don't block
  // but we keep indicator in red until rates exist.
}

init();
</script>
</body>
</html>
